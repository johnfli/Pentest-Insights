package com.business.starter.backend.services;

import com.business.starter.backend.entities.Scan;
import com.business.starter.backend.repositories.ScanRepository;
import com.business.starter.backend.services.util.RefactorJavaFile;
import com.business.starter.backend.services.util.PropertiesFile;
import org.apache.maven.cli.MavenCli;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.List;
import java.util.function.Consumer;
import java.util.logging.Level;
import java.util.logging.Logger;

@Service
public class ScanService {
    private static final Logger LOGGER = Logger.getLogger(ScanService.class.getName());

    private final ScanRepository scanRepository;

    @Autowired
    public ScanService(ScanRepository scanRepository) {
        this.scanRepository = scanRepository;
    }

    public List<Scan> findAll() {
        return scanRepository.findAll();
    }

    public List<Scan> findAll(String filterText) {
        if(filterText == null || filterText.isEmpty()) {
            return scanRepository.findAll();
        }
        else {
            return scanRepository.search(filterText);
        }
    }

    public List<Scan> findAllByUserId(long userId, String filterText) {
        if(filterText == null || filterText.isEmpty()) {
            return scanRepository.findByUserId(userId);
        }
        else {
            return scanRepository.searchByUserId(userId, filterText);
        }
    }

    public Scan findById(long id) {
        return scanRepository.findById(id);
    }
    public Scan findByIdAndUserId(long id, long userId) {
        return scanRepository.findByIdAndUserId(id, userId);
    }

    public List<Scan> findPreviousScanByIdAndUserId(long id, long userId, String zapOptions) {
        return scanRepository.findPreviousScanByIdAndUserId(id, userId, zapOptions);
    }

    public long count() {
        return scanRepository.count();
    }

    public void delete(Scan scan) {
        scanRepository.delete(scan);
        if (deleteDirectory(new File(scan.getJavaFilePath())))
            System.out.println("Scan and corresponding folder deleted successfully.");
        else
            System.out.println("Scan deleted but problem deleting the corresponding folder.");
    }

    boolean deleteDirectory(File directoryToBeDeleted) {
        File[] allContents = directoryToBeDeleted.listFiles();
        if (allContents != null) {
            for (File file : allContents) {
                deleteDirectory(file);
            }
        }
        return directoryToBeDeleted.delete();
    }

    public void save(Scan scan) {
        if (scan == null) {
            LOGGER.log(Level.SEVERE,
                    "This scan is null. Are you sure you have connected your form to the application?");
            return;
        }
        scanRepository.save(scan);
    }

    public void testApp(Scan scan) {

        while (PropertiesFile.isScanningAnotherApp() == 0)
            sleep();

        PropertiesFile.writePropertiesFile(scan.getBrowserType().toString(),
                scan.getHeadlessMode().toString(), scan.getZapOptions());
        try {
            new RefactorJavaFile().refactorJavaFile(scan.getJavaFilePath(), scan.getJavaFileName());
        } catch (Exception e) {
            System.out.println(" === Problem in refactoring the Java File. ===");
            e.printStackTrace();
        }
        if (setUpScanFolder(scan) == 1) {
            System.err.println("Error copying .java file into the .../" + scan.getId() + "/ folder.");
            scan.setStatus(Scan.Status.ABORTED);
            save(scan);
            return;
        }
        save(scan);
        scan.setStatus(Scan.Status.RUNNING);
        save(scan);
        // Run the TestNG test suite
        System.out.println("========= Maven CLI to be executed =========");
        MavenCli cli = new MavenCli();
        System.setProperty("maven.multiModuleProjectDirectory", ".");
        int cliResult = cli.doMain(new String[]{"-U", "-X","clean", "test"}, "security-project", System.out, System.out);
        System.out.println("========= Maven CLI returned ========= (cli result error code was : " + cliResult + ")");

        if (saveScanResults(scan) == 0)
            scan.setStatus(Scan.Status.FINISHED);
        else {
            System.err.println("Error copying results into the .../" + scan.getUserId() +
                                "/" + scan.getId() + "/reports folder.");
            scan.setStatus(Scan.Status.ABORTED);
        }
        save(scan);
        PropertiesFile.setScanningDone();
    }

    /***     Scan Specific Folder: scr/main/resources/javaFiles/<UserId>/<ScanId>    ***/
    private int setUpScanFolder(Scan scan) {
        try {
            // Move the uploaded test file into the equivalent scan folder (folder name: <ScanId>)
            String srcFilePath = scan.getJavaFilePath();
            scan.setJavaFilePath(srcFilePath + scan.getId().toString() + "/");
            String targetFilePath = scan.getJavaFilePath();
            File dir = new File(targetFilePath);
            if (!dir.exists()) dir.mkdirs();
            Files.move(
                    Paths.get(srcFilePath + scan.getJavaFileName()),
                    Paths.get(targetFilePath + scan.getJavaFileName())
            );
            return 0;
        } catch (IOException e) {
            System.out.println("IOException : ");
            e.printStackTrace();
            return 1;
        }
    }
    /***     Scan Results Folder: scr/main/resources/javaFiles/<UserId>/<ScanId>/reports    ***/
    private int saveScanResults(Scan scan) {
        try {
            // Retrieve the test results and place them into the <ScanId>/reports folder
            String targetFilePath = scan.getJavaFilePath() + "reports";
            File dir = new File(targetFilePath);
            if (!dir.exists()) dir.mkdirs();
            Files.move(
                    Paths.get("security-project" +
                            "/reports/ZapReport.html"),
                    Paths.get(targetFilePath + "/ZapReport.html")
            );
            Files.move(
                    Paths.get("security-project" +
                            "/reports/ZapReport.json"),
                    Paths.get(targetFilePath + "/ZapReport.json")
            );
            Files.move(
                    Paths.get("security-project" +
                            "/target/surefire-reports/emailable-report.html"),
                    Paths.get(targetFilePath + "/emailable-report.html")
            );
            Files.move(
                    Paths.get("security-project" +
                            "/target/surefire-reports/testng-results.xml"),
                    Paths.get(targetFilePath + "/testng-results.xml")
            );
            return 0;
        } catch (IOException e) {
            System.out.println("IOException : ");
            e.printStackTrace();
            return 1;
        }
    }

    public void simulateProgress (Scan scan, Consumer<Float> progressListener) {

        while (PropertiesFile.isScanningAnotherApp() == 0)
            sleep();

        int STEPS = 35;
        if(scan.getZapOptions().contains("Crawling"))
            STEPS += 14;
        if(scan.getZapOptions().contains("Passive Scanning"))
            STEPS += 14;
        if(scan.getZapOptions().contains("Active Scanning"))
            STEPS += 18*60;
        if(scan.getZapOptions().contains("AJAX Spidering"))
            STEPS += 10;
        for (int i = 1; i <= STEPS; i++) {
            sleep();
            float processedPercentage = (float) i / STEPS;

            if(processedPercentage>0.95
                    || scan.getStatus().equals(Scan.Status.ABORTED)
                        || scan.getStatus().equals(Scan.Status.FINISHED))
                break;
            else
                progressListener.accept(processedPercentage); // notify progress listener
        }
    }

    private void sleep() {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
